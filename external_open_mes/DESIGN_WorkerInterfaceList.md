# 作業者インターフェース画面 設計書

## 1. 概要

### 目的
製造現場の作業者が生産計画を確認し、作業の開始・終了を記録するためのインターフェース画面を提供する。

### 対象ユーザー
- 製造現場の作業者
- 工程担当者
- 現場監督者

### 主要機能
1. 作業者情報入力（作業者ID、工程選択）
2. 生産計画一覧表示（工程別フィルタリング）
3. 作業開始・終了ボタンによるステータス更新
4. リアルタイム操作履歴表示
5. 本日の製作完了予定残数の表示
6. 日報作成機能（準備中）

## 2. UI/UX設計

### 2.1 レイアウト構成

```
┌─────────────────────────────────────────────────────────┐
│ ヘッダー: 物件数 | 製作数 | [日報作成]                    │
├─────────────────────────────────────────────────────────┤
│ 本日の製作完了予定残数                                    │
│   物件: XX件  |  製作: XX個                              │
├─────────────────────────────────────────────────────────┤
│ 作業者情報入力                                            │
│ [作業者ID] [工程選択] [現在時刻]                         │
├─────────────────────────────────────────────────────────┤
│ 生産計画一覧                                              │
│ ┌────────────────────────────────────────────────────┐ │
│ │区分│受付No│追加No│現場名│追加内容│品名│製作数│    │ │
│ │    │      │      │      │        │    │      │予定日│開始終了│
│ ├────────────────────────────────────────────────────┤ │
│ │スリット│24112│15│東京…│-16~19│受桟│49│5/14│[開始]│未着手││
│ │カット  │25602│0 │横浜…│L31   │WD │117│5/19│[終了]│着手中││
│ └────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│ 操作履歴                                                  │
│ 12:34:56 - 工程「スリット」を選択しました                │
│ 12:35:12 - 工程開始: 計画ID xxx                         │
└─────────────────────────────────────────────────────────┘
```

### 2.2 カラーパレット

```css
:root {
  /* ステータス色 */
  --status-not-started: #f8f9fa;    /* 未着手: 薄灰色 */
  --status-in-progress: #d4edda;    /* 着手中: 薄緑色 */
  --status-completed: #f8d7da;      /* 完了: 薄赤色 */
  --status-delayed: #fff3cd;        /* 遅延: 薄黄色 */
  --status-on-hold: #d1ecf1;        /* 保留: 薄青色 */
  --status-cancelled: #f5c6cb;      /* 中止: 濃い赤 */

  /* ボタン色 */
  --btn-start: #28a745;             /* 開始ボタン: 緑 */
  --btn-end: #dc3545;               /* 終了ボタン: 赤 */
  --btn-disabled: #6c757d;          /* 無効ボタン: 灰色 */

  /* ヘッダー色 */
  --header-bg: #343a40;             /* ダークグレー */
  --header-text: #ffffff;           /* 白 */
}
```

### 2.3 レスポンシブ対応

- **デスクトップ (≥1200px)**: 全機能表示、横スクロールなし
- **タブレット (768px-1199px)**: テーブル横スクロール対応
- **モバイル (≤767px)**: カード形式表示、縦スクロール最適化

## 3. 機能仕様

### 3.1 作業者情報入力

**フィールド:**
- **作業者ID** (必須): テキスト入力
- **工程選択** (必須): セレクトボックス
  - スリット
  - カット
  - 基材カット
  - モルダー
  - Vカットラッピング
  - 後加工
  - 梱包
  - 化粧板貼付
  - 化粧板カット
- **現在時刻**: 自動更新（1秒ごと）

**バリデーション:**
- 作業者IDと工程選択は必須
- 作業開始・終了操作時にチェック

### 3.2 生産計画一覧

**表示項目:**
1. 区分（工程名）
2. 受付No.
3. 追加No.
4. 現場名
5. 追加内容
6. 品名
7. 製作数
8. 予定日（選択工程の予定日）
9. 開始終了ボタン + ステータスバッジ

**フィルタリング:**
- 工程選択時、選択工程に関連する計画のみ表示
- 完了・中止済みの計画は非表示
- 予定日順にソート（早い順）

**ページネーション:**
- 100件/ページ
- ページ番号表示とナビゲーションボタン

### 3.3 作業開始・終了機能

**動作フロー:**

```
1. 作業者が「開始」ボタンをクリック
   ↓
2. フロントエンド: 楽観的UI更新（即座にボタン→「終了」、ステータス→「着手中」）
   ↓
3. バックグラウンド: APIリクエスト送信
   POST /api/production/plans/update-process-status/
   {
     plan_id: "uuid",
     process_type: "slit",
     action: "start",
     worker_id: "W001",
     timestamp: "2025-10-07T12:34:56+09:00"
   }
   ↓
4. API成功時: 操作履歴に記録、単一計画同期
   ↓
5. API失敗時: UIロールバック、エラーメッセージ表示
```

**楽観的UI更新:**
- ユーザー体験向上のため、API応答を待たずにUI更新
- エラー時は元の状態に自動ロールバック
- 5分ごとにバックグラウンド同期で全データ更新

**ステータス遷移:**
```
未着手 (PENDING)
  → [開始] → 着手中 (IN_PROGRESS)
    → [終了] → 完了 (COMPLETED) ※完了後は操作不可
```

### 3.4 操作履歴

**表示内容:**
- タイムスタンプ（時:分:秒）
- 操作メッセージ
- ステータス（info, success, error）に応じた色分け

**特徴:**
- 最新の履歴を最上部に表示
- スクロール可能（最大高さ200px）
- システム初期化、データ読み込み、工程選択、作業開始/終了を記録

### 3.5 サマリー表示

**表示項目:**
- **物件数**: 生産計画の総件数
- **製作数**: 計画数量の合計

**更新タイミング:**
- 初回データ読み込み時
- 工程選択変更時
- 作業ステータス更新時

### 3.6 日報作成機能

**現在のステータス**: 準備中

**将来の実装予定:**
- 当日の作業実績を集計
- PDF/CSV形式でエクスポート
- メール送信機能

## 4. API設計

### 4.1 生産計画一覧取得

**エンドポイント**: `GET /api/production/plans/`

**クエリパラメータ:**
- `page_size`: ページサイズ（デフォルト: 100）
- `page`: ページ番号

**レスポンス:**
```json
{
  "count": 107,
  "next": "http://localhost/api/production/plans/?page=2",
  "previous": null,
  "results": [
    {
      "id": "uuid",
      "qr_code": "241120150",
      "reception_no": "24112",
      "additional_no": "15",
      "customer_name": "株式会社ABC",
      "site_name": "東京日商E八王子市東浅川町",
      "additional_content": "-16~19",
      "product_code": "受桟 (ラ)",
      "planned_quantity": 49,
      "process": "ラッピング",
      "slit_scheduled_date": null,
      "cut_scheduled_date": "2025-05-14",
      "molder_scheduled_date": null,
      "vcut_wrapping_scheduled_date": "2025-05-19",
      "post_processing_scheduled_date": null,
      "packing_scheduled_date": null,
      "delivery_date": "2025-08-03",
      "veneer_scheduled_date": null,
      "cut_veneer_scheduled_date": null,
      "status": "PENDING",
      "status_display": "未着手",
      "slit_status": "未着手",
      "cut_status": "未着手",
      "molder_status": "未着手",
      "vcut_status": "未着手",
      "post_status": "未着手",
      "packing_status": "未着手",
      "veneer_status": "未着手",
      "cut_veneer_status": "未着手"
    }
  ]
}
```

### 4.2 工程ステータス更新

**エンドポイント**: `POST /api/production/plans/update-process-status/`

**リクエストボディ:**
```json
{
  "plan_id": "uuid",
  "process_type": "slit",
  "action": "start",
  "worker_id": "W001",
  "timestamp": "2025-10-07T12:34:56+09:00"
}
```

**アクション:**
- `start`: 作業開始（PENDING → IN_PROGRESS）
- `complete`: 作業完了（IN_PROGRESS → COMPLETED）

**レスポンス（成功）:**
```json
{
  "success": true,
  "message": "スリット工程を開始しました",
  "plan_id": "uuid",
  "process_type": "slit",
  "new_status": "IN_PROGRESS",
  "timestamp": "2025-10-07T12:34:56+09:00"
}
```

**レスポンス（エラー）:**
```json
{
  "success": false,
  "error": "この工程は既に完了しています",
  "plan_id": "uuid",
  "process_type": "slit"
}
```

### 4.3 単一計画取得

**エンドポイント**: `GET /api/production/plans/{id}/`

**用途**: 作業ステータス更新後の同期確認

**レスポンス**: 単一の生産計画オブジェクト

## 5. 状態管理

### 5.1 Reactステート

```javascript
const [productionPlans, setProductionPlans] = useState([]);
const [filteredPlans, setFilteredPlans] = useState([]);
const [workerId, setWorkerId] = useState('');
const [selectedProcess, setSelectedProcess] = useState('');
const [currentTime, setCurrentTime] = useState(new Date());
const [operationHistory, setOperationHistory] = useState([]);
const [summaryData, setSummaryData] = useState({
  totalItems: 0,
  totalProduction: 0
});
const [loading, setLoading] = useState(false);
const [error, setError] = useState(null);
```

### 5.2 副作用管理

**useEffect依存:**
- 初回データ読み込み: `[]`（マウント時のみ）
- 工程フィルタリング: `[productionPlans, selectedProcess]`
- 現在時刻更新: `[]`（1秒インターバル）
- バックグラウンド同期: `[]`（5分インターバル）

## 6. パフォーマンス最適化

### 6.1 楽観的UI更新

- API応答を待たずにUI即座更新
- ユーザー体験向上（レスポンス時間 <100ms）
- エラー時の自動ロールバック機能

### 6.2 差分更新

- 作業ステータス更新後、単一計画のみ再取得
- 全データ再取得は5分ごとのバックグラウンド同期のみ
- 不要な再レンダリングを最小化

### 6.3 データフィルタリング

- クライアント側でフィルタリング（サーバー負荷軽減）
- 完了・中止済み計画の除外
- 予定日順ソート

## 7. エラーハンドリング

### 7.1 バリデーションエラー

- 作業者ID未入力: アラート表示
- 工程未選択: アラート表示
- 即座にユーザーへフィードバック

### 7.2 APIエラー

- ネットワークエラー: 操作履歴にエラー記録、UIロールバック
- 認証エラー: ログイン画面へリダイレクト
- サーバーエラー: エラーメッセージ表示、再試行オプション

### 7.3 データエラー

- 計画が見つからない: エラーメッセージ表示
- 無効なステータス遷移: サーバー側でバリデーション、エラー返却

## 8. セキュリティ

### 8.1 認証・認可

- Token認証必須（authFetch経由）
- 作業者IDの記録とトレーサビリティ
- CSRF対策（Django標準）

### 8.2 データ検証

- サーバー側での厳密なバリデーション
- SQLインジェクション対策（Django ORM）
- XSS対策（React自動エスケープ）

## 9. 実装優先順位

### Phase 1: 基本機能（MVP）
1. ✅ 作業者情報入力UI
2. ✅ 生産計画一覧表示
3. ✅ 工程フィルタリング
4. ✅ 作業開始・終了ボタン
5. ✅ 楽観的UI更新
6. ✅ 操作履歴表示

### Phase 2: UX向上
1. ✅ サマリー表示
2. ✅ リアルタイム現在時刻
3. ✅ バックグラウンド同期
4. ✅ ページネーション
5. ✅ レスポンシブデザイン

### Phase 3: 拡張機能（今後）
1. ⏳ 日報作成機能
2. ⏳ QRコードスキャン連携
3. ⏳ 音声フィードバック
4. ⏳ オフライン対応
5. ⏳ プッシュ通知

## 10. テスト要件

### 10.1 ユニットテスト

- 工程フィルタリングロジック
- ステータス判定ロジック
- 日付フォーマット関数
- 楽観的UI更新/ロールバック

### 10.2 統合テスト

- API通信（成功/失敗シナリオ）
- 認証フロー
- データ同期処理

### 10.3 E2Eテスト (Playwright)

- 作業開始・終了の完全フロー
- 工程選択とフィルタリング
- エラー時のUIロールバック
- バックグラウンド同期

### 10.4 パフォーマンステスト

- 大量データ表示（1000件以上）
- API応答時間測定
- UI更新レスポンス時間（目標: <100ms）

## 11. ブラウザ互換性

- **Chrome**: 最新版 + 1つ前のバージョン
- **Firefox**: 最新版 + 1つ前のバージョン
- **Safari**: 最新版（iOS含む）
- **Edge**: 最新版

## 12. アクセシビリティ

- **WCAG 2.1 AA準拠**
- キーボードナビゲーション対応
- スクリーンリーダー対応
- 色覚異常対応（色だけでなくテキストでステータス表示）
- コントラスト比 4.5:1以上

## 13. 今後の拡張案

### 13.1 QRコードスキャン

- カメラAPIを使用したQRコード読み取り
- 生産計画の自動選択
- 作業者IDのQRコード連携

### 13.2 音声フィードバック

- 作業開始・終了時の音声通知
- エラー時の警告音
- Web Speech API活用

### 13.3 オフライン対応

- Service Workerによるキャッシング
- オフライン時のローカルストレージ保存
- オンライン復帰時の自動同期

### 13.4 リアルタイム更新

- WebSocket接続による即時更新
- 他の作業者の作業状況をリアルタイム表示
- 競合検知と通知

## 14. 参考資料

- 既存実装: `/Users/okinotakumiware/open-mes-project/open_mes/scr/templates/production/worker_interface_list.html`
- API仕様: Django REST Framework
- UI参考: Bootstrap 5.3.0
- 状態管理: React Hooks (useState, useEffect, useCallback)
