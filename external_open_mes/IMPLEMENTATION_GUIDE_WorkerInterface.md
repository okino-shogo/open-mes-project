# 作業者インターフェース画面 実装ガイド

## 概要

このガイドでは、external_open_mesに追加された作業者インターフェース（リスト形式）画面の実装内容と使用方法を説明します。

## 作成されたファイル

### 1. 設計書
**ファイル**: `DESIGN_WorkerInterfaceList.md`

**内容**:
- UI/UX設計の詳細
- 機能仕様（作業者情報入力、生産計画一覧、作業開始/終了機能）
- API設計
- 状態管理とパフォーマンス最適化
- セキュリティとアクセシビリティ要件

### 2. Reactコンポーネント
**ファイル**: `frontend/src/pages/WorkerInterfaceList.jsx` (681行)

**機能**:
- ✅ 作業者ID入力と工程選択
- ✅ 生産計画一覧表示（工程別フィルタリング）
- ✅ 作業開始・終了ボタンによるステータス更新
- ✅ 楽観的UI更新とエラー時のロールバック
- ✅ リアルタイム操作履歴表示
- ✅ 本日の製作完了予定残数サマリー
- ✅ バックグラウンド同期（5分ごと）
- ✅ レスポンシブデザイン

**対応工程**:
1. スリット
2. カット
3. 基材カット
4. モルダー
5. Vカットラッピング
6. 後加工
7. 梱包
8. 化粧板貼付
9. 化粧板カット

### 3. スタイルシート
**ファイル**: `frontend/src/pages/WorkerInterfaceList.css` (380行)

**特徴**:
- ✅ ステータス色分け（未着手/着手中/完了/遅延/保留/中止）
- ✅ 作業開始・終了ボタンのスタイル
- ✅ レスポンシブデザイン（モバイル/タブレット/デスクトップ）
- ✅ アクセシビリティ対応（WCAG 2.1 AA準拠）
- ✅ ダークモード対応（将来の拡張）
- ✅ プリント対応

### 4. バックエンドAPI
**ファイル**: `backend/src/production/rest_views.py`

**追加されたエンドポイント**: `update-process-status`

```python
@action(detail=False, methods=['post'], url_path='update-process-status')
def update_process_status(self, request):
    """
    作業者インターフェースから工程のステータスを更新するエンドポイント
    WorkProgressモデルを使用して作業記録を管理
    """
```

**機能**:
- 作業開始時: WorkProgressレコード作成（status='IN_PROGRESS'）
- 作業完了時: WorkProgressレコード更新（status='COMPLETED', end_datetime設定）
- 作業者ID、工程タイプ、タイムスタンプの記録
- トランザクション処理による整合性保証

## 実装状況

### ✅ Phase 1完了: 基本機能（MVP）
- [x] 作業者情報入力UI実装
- [x] 生産計画一覧表示
- [x] 工程フィルタリング
- [x] 作業開始・終了ボタン
- [x] 楽観的UI更新
- [x] 操作履歴表示
- [x] バックエンドAPIエンドポイント実装
- [x] フロントエンド統合（App.jsx, SideMenu.jsx）

### ✅ Phase 2完了: UX向上
- [x] サマリー表示（物件数、製作数）
- [x] リアルタイム現在時刻表示
- [x] バックグラウンド同期（5分ごと）
- [x] ページネーション対応準備
- [x] レスポンシブデザイン

### ⏳ Phase 3: 拡張機能（今後）
- [ ] 日報作成機能
- [ ] QRコードスキャン連携
- [ ] 音声フィードバック
- [ ] オフライン対応
- [ ] プッシュ通知

## 使用方法

### 1. アクセス方法

サイドメニューから「生産管理」→「作業者インターフェース」を選択、またはURLで直接アクセス：
```
http://localhost:8100/production/worker-interface
```

### 2. 基本操作フロー

#### ステップ1: 作業者情報入力
1. **作業者ID**: 作業者のユーザーIDを入力（例: `W001`, `admin`）
2. **工程選択**: 担当する工程をセレクトボックスから選択
3. **現在時刻**: 自動表示（1秒ごと更新）

#### ステップ2: 生産計画の確認
- 選択した工程に関連する生産計画が一覧表示されます
- 表示項目：
  - 区分（工程名）
  - 受付No.
  - 追加No.
  - 現場名
  - 追加内容
  - 品名
  - 製作数
  - 予定日
  - 開始終了ボタン + ステータスバッジ

#### ステップ3: 作業開始
1. 対象の生産計画行の「開始」ボタンをクリック
2. 即座にUI更新：ボタンが「終了」に変更、ステータスが「着手中」に変更
3. 操作履歴に「工程開始」が記録
4. バックグラウンドでAPIリクエスト送信

#### ステップ4: 作業完了
1. 作業完了時に「終了」ボタンをクリック
2. 即座にUI更新：ステータスが「完了」に変更、ボタンが無効化
3. 操作履歴に「工程完了」が記録
4. バックグラウンドでAPIリクエスト送信

### 3. エラー時の動作

**API通信エラー時**:
- UIが自動的に元の状態にロールバック
- 操作履歴にエラーメッセージ表示
- ユーザーに再試行を促すメッセージ

**バリデーションエラー時**:
- 作業者ID未入力: アラート表示「作業者IDを入力してください」
- 工程未選択: アラート表示「工程を選択してください」
- 無効なステータス遷移: エラーメッセージ表示

## API仕様

### エンドポイント

**URL**: `POST /api/production/plans/update-process-status/`

**リクエストボディ**:
```json
{
  "plan_id": "uuid",
  "process_type": "slit",
  "action": "start",
  "worker_id": "W001",
  "timestamp": "2025-10-07T12:34:56+09:00"
}
```

**パラメータ**:
- `plan_id` (必須): 生産計画のUUID
- `process_type` (必須): 工程タイプ（slit, cut, molder, 等）
- `action` (必須): アクション（`start` または `complete`）
- `worker_id` (必須): 作業者のユーザーID
- `timestamp` (オプショナル): タイムスタンプ（省略時は現在時刻）

**レスポンス（成功）**:
```json
{
  "success": true,
  "message": "スリット工程を開始しました",
  "plan_id": "uuid",
  "process_type": "slit",
  "new_status": "IN_PROGRESS",
  "timestamp": "2025-10-07T12:34:56+09:00",
  "work_progress_id": "uuid"
}
```

**レスポンス（エラー）**:
```json
{
  "success": false,
  "error": "この工程は既に完了しています"
}
```

## データベース設計

### WorkProgressモデル

作業実績は`WorkProgress`モデルに記録されます。

**主要フィールド**:
- `production_plan`: 生産計画（ForeignKey）
- `process_step`: 工程名（CharField）
- `operator`: 作業者（ForeignKey to User, nullable）
- `start_datetime`: 作業開始時刻
- `end_datetime`: 作業終了時刻（nullable）
- `status`: ステータス（PENDING, IN_PROGRESS, COMPLETED, 等）
- `quantity_completed`: 完了数量
- `remarks`: 備考（作業者IDを記録）

## パフォーマンス最適化

### 楽観的UI更新

- **目的**: ユーザー体験向上（レスポンス時間 <100ms）
- **動作**: API応答を待たずにUI即座更新
- **エラー時**: 自動ロールバックでデータ整合性保証

### バックグラウンド同期

- **頻度**: 5分ごと
- **目的**: 他の作業者の更新を反映
- **動作**: サイレントモード（操作履歴に通知なし）

### クライアント側フィルタリング

- **目的**: サーバー負荷軽減
- **動作**: フロントエンドで工程フィルタリングとソート処理
- **効果**: API呼び出し回数削減

## セキュリティ

### 認証・認可

- Token認証必須（authFetch経由）
- 作業者IDの記録とトレーサビリティ
- CSRF対策（Django標準）

### データ検証

- サーバー側での厳密なバリデーション
- SQLインジェクション対策（Django ORM）
- XSS対策（React自動エスケープ）

## トラブルシューティング

### データが表示されない

**症状**: テーブルに「データがありません」と表示

**原因と対処**:
1. **生産計画データが存在しない**:
   - データインポート画面からCSVをアップロード
   - データタイプ: `production_plan`

2. **API接続エラー**:
   - ブラウザの開発者ツールでNetworkタブを確認
   - `/api/production/plans/` のレスポンスを確認

3. **認証エラー**:
   - ログインしているか確認
   - トークンが有効か確認

### 作業開始ボタンが動作しない

**症状**: ボタンをクリックしてもステータスが更新されない

**原因と対処**:
1. **作業者ID未入力**:
   - 作業者IDフィールドに値を入力

2. **工程未選択**:
   - 工程セレクトボックスから工程を選択

3. **API エラー**:
   - 操作履歴のエラーメッセージを確認
   - ネットワークエラーの場合は接続確認

### ステータスが正しく更新されない

**症状**: 完了ボタンをクリックしても「完了」にならない

**原因と対処**:
1. **WorkProgressレコードが存在しない**:
   - 先に「開始」ボタンをクリックして作業開始する必要がある

2. **サーバー側エラー**:
   - バックエンドログを確認: `docker compose logs backend`
   - WorkProgressモデルの状態を確認

## 動作確認チェックリスト

### 基本機能

- [ ] 画面が正常に表示される
- [ ] 作業者IDを入力できる
- [ ] 工程を選択できる
- [ ] 現在時刻が1秒ごとに更新される
- [ ] 生産計画一覧が表示される
- [ ] 工程選択時にフィルタリングされる
- [ ] 作業開始ボタンが機能する
- [ ] 作業終了ボタンが機能する
- [ ] 操作履歴が表示される
- [ ] サマリー（物件数、製作数）が表示される

### エラーハンドリング

- [ ] 作業者ID未入力時にアラートが表示される
- [ ] 工程未選択時にアラートが表示される
- [ ] API エラー時にロールバックされる
- [ ] エラーメッセージが操作履歴に表示される

### パフォーマンス

- [ ] UI更新が100ms以内に完了する
- [ ] バックグラウンド同期が5分ごとに動作する
- [ ] 大量データ（100件以上）でも快適に動作する

### レスポンシブ

- [ ] デスクトップで正常に表示される
- [ ] タブレットで正常に表示される
- [ ] モバイルで正常に表示される

## 今後の拡張予定

### Phase 3: 拡張機能

**日報作成機能**:
- 当日の作業実績を自動集計
- PDF/CSV形式でエクスポート
- メール送信機能

**QRコードスキャン**:
- カメラAPIを使用したQRコード読み取り
- 生産計画の自動選択
- 作業者IDのQRコード連携

**音声フィードバック**:
- 作業開始・終了時の音声通知
- エラー時の警告音
- Web Speech API活用

**オフライン対応**:
- Service Workerによるキャッシング
- オフライン時のローカルストレージ保存
- オンライン復帰時の自動同期

**リアルタイム更新**:
- WebSocket接続による即時更新
- 他の作業者の作業状況をリアルタイム表示
- 競合検知と通知

## 参考資料

### 関連ファイル

- **既存実装**: `/Users/okinotakumiware/open-mes-project/open_mes/scr/templates/production/worker_interface_list.html`
- **設計書**: `DESIGN_WorkerInterfaceList.md`
- **モデル**: `backend/src/production/models.py` (WorkProgress)
- **API**: `backend/src/production/rest_views.py` (update-process-status)

### 技術ドキュメント

- React: https://react.dev/
- Bootstrap 5: https://getbootstrap.com/docs/5.3/
- Django REST Framework: https://www.django-rest-framework.org/
- WorkProgress モデル仕様: `backend/src/production/models.py`

## まとめ

作業者インターフェース画面は、製造現場の作業者が生産計画を確認し、作業の開始・終了を記録するための専用UIです。

**完了した作業**:
- ✅ 設計書作成（DESIGN_WorkerInterfaceList.md）
- ✅ Reactコンポーネント実装（WorkerInterfaceList.jsx）
- ✅ スタイルシート作成（WorkerInterfaceList.css）
- ✅ バックエンドAPIエンドポイント実装（update-process-status）
- ✅ フロントエンド統合（App.jsx, SideMenu.jsx）
- ✅ 実装ガイド作成（本ドキュメント）

**次のステップ**:
1. 動作確認とテスト
2. ユーザーフィードバック収集
3. Phase 3拡張機能の実装計画

ご確認いただき、フィードバックがあればお知らせください。
